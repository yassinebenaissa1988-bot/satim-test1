const { onRequest } = require("firebase-functions/v2/https");
const { setGlobalOptions } = require("firebase-functions");
const cors = require("cors");

setGlobalOptions({ maxInstances: 10 });

const corsHandler = cors({ origin: true }); // autorise toutes les origines

exports.createSatimPayment = onRequest((req, res) => {
  corsHandler(req, res, async () => {
    try {
      const { amount, orderId } = req.body || {};

      const response = await fetch("https://test.satim.dz/payment/rest/register.do", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          userName: "VOTRE_USERNAME_SATIM",
          password: "VOTRE_MOTDEPASSE_SATIM",
          orderNumber: orderId || "TEST-12345",
          amount: amount || 20000, // 200 DZD = 20000 centimes
          currency: "012",
          returnUrl: "https://carsellapp-d3b2f.web.app/payment-success",
          failUrl: "https://carsellapp-d3b2f.web.app/payment-fail",
        }),
      });

      const result = await response.json();
      console.log("Réponse SATIM:", result);

      return res.status(200).json({
        success: true,
        message: "Appel SATIM réussi ✅",
        data: result,
      });
    } catch (error) {
      console.error("Erreur SATIM:", error);
      return res.status(500).json({
        success: false,
        message: "Erreur lors de la création du paiement SATIM",
        error: error.message,
      });
    }
  });
});

